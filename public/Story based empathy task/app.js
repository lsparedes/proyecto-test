const imagenes = [
    {
        preliminar: "imagenes/practica/SET_item_practica_page-0001.jpg",
        src: "imagenes/practica/SET_item_practica1.jpg",
        textoDistintivo: "P1",
        options: [
            { src: "imagenes/practica/A.jpg", correct: false },
            { src: "imagenes/practica/B.jpg", correct: true },
            { src: "imagenes/practica/C.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/1-SET.IA/1/1_SET-IA_item1.jpg",
        src: "imagenes/1-SET.IA/1/1_SET-IA_item1.1.jpg",
        textoDistintivo: "IA 1",
        options: [
            { src: "imagenes/1-SET.IA/1/1_SET-IA_item1.2.jpg", correct: false },
            { src: "imagenes/1-SET.IA/1/1_SET-IA_item1.3.jpg", correct: false },
            { src: "imagenes/1-SET.IA/1/1_SET-IA_item1.4.jpg", correct: true },
        ]
    },
    {
        preliminar: "imagenes/1-SET.IA/2/1_SET-IA_item2.jpg",
        src: "imagenes/1-SET.IA/2/1_SET-IA_item2.1.jpg",
        textoDistintivo: "IA 2",
        options: [
            { src: "imagenes/1-SET.IA/2/1_SET-IA_item2.2.jpg", correct: false },
            { src: "imagenes/1-SET.IA/2/1_SET-IA_item2.3.jpg", correct: true },
            { src: "imagenes/1-SET.IA/2/1_SET-IA_item2.4.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/1-SET.IA/3/1_SET-IA_item3.jpg",
        src: "imagenes/1-SET.IA/3/1_SET-IA_item3.1.jpg",
        textoDistintivo: "IA 3",
        options: [
            { src: "imagenes/1-SET.IA/3/1_SET-IA_item3.2.jpg", correct: false },
            { src: "imagenes/1-SET.IA/3/1_SET-IA_item3.3.jpg", correct: true },
            { src: "imagenes/1-SET.IA/3/1_SET-IA_item3.4.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/1-SET.IA/4/1_SET-IA_item4.jpg",
        src: "imagenes/1-SET.IA/4/1_SET-IA_item4.1.jpg",
        textoDistintivo: "IA 4",
        options: [
            { src: "imagenes/1-SET.IA/4/1_SET-IA_item4.2.jpg", correct: true },
            { src: "imagenes/1-SET.IA/4/1_SET-IA_item4.3.jpg", correct: false },
            { src: "imagenes/1-SET.IA/4/1_SET-IA_item4.4.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/1-SET.IA/5/1_SET-IA_item5.jpg",
        src: "imagenes/1-SET.IA/5/1_SET-IA_item5.1.jpg",
        textoDistintivo: "IA 5",
        options: [
            { src: "imagenes/1-SET.IA/5/1_SET-IA_item5.2.jpg", correct: true },
            { src: "imagenes/1-SET.IA/5/1_SET-IA_item5.3.jpg", correct: false },
            { src: "imagenes/1-SET.IA/5/1_SET-IA_item5.4.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/1-SET.IA/6/1_SET-IA_item6.jpg",
        src: "imagenes/1-SET.IA/6/1_SET-IA_item6.1.jpg",
        textoDistintivo: "IA 6",
        options: [
            { src: "imagenes/1-SET.IA/6/1_SET-IA_item6.2.jpg", correct: false },
            { src: "imagenes/1-SET.IA/6/1_SET-IA_item6.3.jpg", correct: true },
            { src: "imagenes/1-SET.IA/6/1_SET-IA_item6.4.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/2-SET-CI/1/2_SET-CI_item1.jpg",
        src: "imagenes/2-SET-CI/1/2_SET-CI_item1.1.jpg",
        textoDistintivo: "CI 1",
        options: [
            { src: "imagenes/2-SET-CI/1/2_SET-CI_item1.2.jpg", correct: true },
            { src: "imagenes/2-SET-CI/1/2_SET-CI_item1.3.jpg", correct: false },
            { src: "imagenes/2-SET-CI/1/2_SET-CI_item1.4.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/2-SET-CI/2/2_SET-CI_item2.jpg",
        src: "imagenes/2-SET-CI/2/2_SET-CI_item2.1.jpg",
        textoDistintivo: "CI 2",
        options: [
            { src: "imagenes/2-SET-CI/2/2_SET-CI_item2.2.jpg", correct: false },
            { src: "imagenes/2-SET-CI/2/2_SET-CI_item2.3.jpg", correct: false },
            { src: "imagenes/2-SET-CI/2/2_SET-CI_item2.4.jpg", correct: true },
        ]
    },
    {
        preliminar: "imagenes/2-SET-CI/3/2_SET-CI_item3.jpg",
        src: "imagenes/2-SET-CI/3/2_SET-CI_item3.1.jpg",
        textoDistintivo: "CI 3",
        options: [
            { src: "imagenes/2-SET-CI/3/2_SET-CI_item3.2.jpg", correct: false },
            { src: "imagenes/2-SET-CI/3/2_SET-CI_item3.3.jpg", correct: true },
            { src: "imagenes/2-SET-CI/3/2_SET-CI_item3.4.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/2-SET-CI/4/2_SET-CI_item4.jpg",
        src: "imagenes/2-SET-CI/4/2_SET-CI_item4.1.jpg",
        textoDistintivo: "CI 4",
        options: [
            { src: "imagenes/2-SET-CI/4/2_SET-CI_item4.2.jpg", correct: false },
            { src: "imagenes/2-SET-CI/4/2_SET-CI_item4.3.jpg", correct: true },
            { src: "imagenes/2-SET-CI/4/2_SET-CI_item4.4.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/2-SET-CI/5/2_SET-CI_item5.jpg",
        src: "imagenes/2-SET-CI/5/2_SET-CI_item5.1.jpg",
        textoDistintivo: "CI 5",
        options: [
            { src: "imagenes/2-SET-CI/5/2_SET-CI_item5.2.jpg", correct: true },
            { src: "imagenes/2-SET-CI/5/2_SET-CI_item5.3.jpg", correct: false },
            { src: "imagenes/2-SET-CI/5/2_SET-CI_item5.4.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/2-SET-CI/6/2_SET-CI_items_prueba_page-0012.jpg",
        src: "imagenes/2-SET-CI/6/2_SET-CI_item6.jpg",
        textoDistintivo: "CI 6",
        options: [
            { src: "imagenes/2-SET-CI/6/2_SET-CI_item6.1.jpg", correct: false },
            { src: "imagenes/2-SET-CI/6/2_SET-CI_item6.2.jpg", correct: false },
            { src: "imagenes/2-SET-CI/6/2_SET-CI_item6.3.jpg", correct: true },
        ]
    },
    {
        preliminar: "imagenes/3-SET-EA/1/3_SET-EA_items_prueba_page-0002.jpg",
        src: "imagenes/3-SET-EA/1/3_SET-EA_item1.jpg",
        textoDistintivo: "EA 1",
        options: [
            { src: "imagenes/3-SET-EA/1/3_SET-EA_item1.1.jpg", correct: false },
            { src: "imagenes/3-SET-EA/1/3_SET-EA_item1.2.jpg", correct: false },
            { src: "imagenes/3-SET-EA/1/3_SET-EA_item1.3.jpg", correct: true },
        ]
    },
    {
        preliminar: "imagenes/3-SET-EA/2/3_SET-EA_items_prueba_page-0004.jpg",
        src: "imagenes/3-SET-EA/2/3_SET-EA_item2.jpg",
        textoDistintivo: "EA 2",
        options: [
            { src: "imagenes/3-SET-EA/2/3_SET-EA_item2.1.jpg", correct: false },
            { src: "imagenes/3-SET-EA/2/3_SET-EA_item2.2.jpg", correct: false },
            { src: "imagenes/3-SET-EA/2/3_SET-EA_item2.3.jpg", correct: true },
        ]
    },
    {
        preliminar: "imagenes/3-SET-EA/3/3_SET-EA_items_prueba_page-0006.jpg",
        src: "imagenes/3-SET-EA/3/3_SET-EA_item3.jpg",
        textoDistintivo: "EA 3",
        options: [
            { src: "imagenes/3-SET-EA/3/3_SET-EA_item3.1.jpg", correct: true },
            { src: "imagenes/3-SET-EA/3/3_SET-EA_item3.2.jpg", correct: false },
            { src: "imagenes/3-SET-EA/3/3_SET-EA_item3.3.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/3-SET-EA/4/3_SET-EA_items_prueba_page-0008.jpg",
        src: "imagenes/3-SET-EA/4/3_SET-EA_item4.jpg",
        textoDistintivo: "EA 4",
        options: [
            { src: "imagenes/3-SET-EA/4/3_SET-EA_item4.1.jpg", correct: false },
            { src: "imagenes/3-SET-EA/4/3_SET-EA_item4.2.jpg", correct: true },
            { src: "imagenes/3-SET-EA/4/3_SET-EA_item4.3.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/3-SET-EA/5/3_SET-EA_items_prueba_page-0010.jpg",
        src: "imagenes/3-SET-EA/5/3_SET-EA_item5.jpg",
        textoDistintivo: "EA 5",
        options: [
            { src: "imagenes/3-SET-EA/5/3_SET-EA_item5.1.jpg", correct: false },
            { src: "imagenes/3-SET-EA/5/3_SET-EA_item5.2.jpg", correct: true },
            { src: "imagenes/3-SET-EA/5/3_SET-EA_item5.3.jpg", correct: false },
        ]
    },
    {
        preliminar: "imagenes/3-SET-EA/6/3_SET-EA_items_prueba_page-0012.jpg",
        src: "imagenes/3-SET-EA/6/3_SET-EA_item6.jpg",
        textoDistintivo: "EA 6",
        options: [
            { src: "imagenes/3-SET-EA/6/3_SET-EA_item6.1.jpg", correct: true },
            { src: "imagenes/3-SET-EA/6/3_SET-EA_item6.2.jpg", correct: false },
            { src: "imagenes/3-SET-EA/6/3_SET-EA_item6.3.jpg", correct: false },
        ]
    },
];


let indiceActual = 0;
let presentacionIniciada = false;

document.getElementById('fullscreenButton').addEventListener('click', function () {
    const element = document.documentElement;
    if (element.requestFullscreen) {
        element.requestFullscreen();
    } else if (element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
    } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen();
    } else if (element.msRequestFullscreen) {
        element.msRequestFullscreen();
    }
});


function mostrarFinalizacion() {
    const imageContainer = document.getElementById('imageContainer');
    imageContainer.innerHTML = 'El test ha finalizado. ¡Gracias por sus respuestas!';
    imageContainer.style.textAlign = 'center';
    imageContainer.style.fontSize = '40px';
    imageContainer.style.display = 'flex';
    imageContainer.style.justifyContent = 'center'; 
    imageContainer.style.alignItems = 'center'; 
    imageContainer.style.height = '90vh'; 
    imageContainer.style.margin = '0'; 
    imageContainer.style.backgroundColor = 'transparent';
    fullscreenButton.style.display = 'none';
    generarArchivoCSV();
}


function iniciarPresentacion() {
    presentacionIniciada = true;
    const imageContainer = document.getElementById('imageContainer');
    const instructionText = document.getElementById('instructionText');
    const instrucciones = document.getElementById('instrucciones');
    const startButton = document.getElementById('startButton');
    const fullscreenButton = document.getElementById('fullscreenButton');
    imageContainer.style.display = 'block';
    instructionText.style.display = 'none';
    instrucciones.style.display = 'none';
    startButton.style.display = 'none';
    fullscreenButton.style.display = 'none';
    mostrarImagen(indiceActual);
}

function mostrarImagenPrincipal() {
    const preliminaryImage = document.getElementById('preliminaryImage');
    const showMainButton = document.getElementById('showMainButton');
    const storyImage = document.getElementById('storyImage');
    const optionsContainer = document.getElementById('optionsContainer');
    const continueButton = document.getElementById('continueButton');
    instructionText.style.display = 'none';
    instrucciones.style.display = 'none';
    // Ocultar imagen preliminar y botón "Mostrar imagen principal"
    preliminaryImage.style.display = 'none';
    showMainButton.style.display = 'none';

    // Mostrar imagen principal
    storyImage.src = imagenes[indiceActual].src;
    storyImage.style.display = 'block';
    continueButton.style.display = 'block';

    // Limpiar opciones anteriores
    optionsContainer.innerHTML = '';

    // Mostrar opciones
    imagenes[indiceActual].options.forEach((option, index) => {
        const optionImage = document.createElement('img');
        optionImage.src = option.src;
        optionImage.classList.add('option');

        // Agregar event listener a cada opción para verificar respuesta
        optionImage.addEventListener('click', () => {
            verificarRespuesta(index);
        });

        optionsContainer.appendChild(optionImage);
    });
    optionsContainer.style.display = 'flex';

    // Agregar event listener al botón "continueButton"
    continueButton.addEventListener('click', () => {
        cambiarImagen();
    });
}


function mostrarImagen(indice) {
    const imagenInfo = imagenes[indice];
    const preliminaryImage = document.getElementById('preliminaryImage');
    const showMainButton = document.getElementById('showMainButton');
    const storyImage = document.getElementById('storyImage');
    const optionsContainer = document.getElementById('optionsContainer');
    const imageContainer = document.getElementById('imageContainer');
    const continueButton = document.getElementById('continueButton');

    // Ocultar todas las imágenes antes de cargar la nueva imagen
    preliminaryImage.style.display = 'none';
    storyImage.style.display = 'none';
    continueButton.style.display = 'none';
    optionsContainer.style.display = 'none'; // Ocultar el contenedor de opciones

    // Mostrar imagen preliminar y botón "Mostrar imagen principal" si no hay imagen de inicio
    if (!imagenInfo.inicio) {
        preliminaryImage.src = imagenInfo.preliminar;
        preliminaryImage.style.display = 'block';
        showMainButton.style.display = 'block';
    } else {
        // Si hay imagen de inicio, mostrarla durante 3 segundos y luego mostrar la imagen preliminar
        const inicioImage = document.getElementById('inicioImage');
        inicioImage.src = imagenInfo.inicio;
        inicioImage.style.display = 'block';

        setTimeout(() => {
            preliminaryImage.src = imagenInfo.preliminar;
            preliminaryImage.style.display = 'block';
            showMainButton.style.display = 'block';
            inicioImage.style.display = 'none'; // Ocultar la imagen de inicio después de 3 segundos
        }, 1500); // Mostrar la imagen de inicio durante 3 segundos
    }

    const existingImageText = document.querySelector('.imageText');
    if (existingImageText) {
        imageContainer.removeChild(existingImageText);
    }

    // Limpiar las opciones anteriores
    optionsContainer.innerHTML = '';

    // Agregar texto distintivo a algunas imágenes
    if (imagenInfo.textoDistintivo) {
        const imageText = document.createElement('div');
        imageText.textContent = imagenInfo.textoDistintivo;
        imageText.classList.add('imageText');
        imageContainer.appendChild(imageText);
    }
}

let tiempoInicio; // Variable para almacenar el tiempo de inicio del temporizador

document.getElementById('showMainButton').addEventListener('click', function () {
    mostrarImagenPrincipal();
    // Iniciar el temporizador al presionar el botón "showMainButton"
    tiempoInicio = Date.now();
});


let cambioHabilitado = true; // Variable para controlar si se puede cambiar de imagen
let respuestaSeleccionada = false; // Variable para verificar si se seleccionó una respuesta

// Array para almacenar la información de las respuestas seleccionadas
let respuestasSeleccionadas = [];

function verificarRespuesta(selectedOptionIndex) {
    const itemActual = imagenes[indiceActual];
    const correctOptionIndex = itemActual.options.findIndex(option => option.correct);
    const esCorrecta = selectedOptionIndex === correctOptionIndex;

    // Calcular el tiempo transcurrido
    const tiempoTranscurrido = Date.now() - tiempoInicio;

    // Agregar la información de la respuesta seleccionada al array
    respuestasSeleccionadas.push({
        item: itemActual.textoDistintivo,
        opcionSeleccionada: selectedOptionIndex,
        esCorrecta: esCorrecta ? 'Si' : 'No',
        tiempo: tiempoTranscurrido // Agregar el tiempo transcurrido al objeto de respuesta
    });

    // Estilizar la opción seleccionada
    document.querySelectorAll('.option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelectorAll('.option')[selectedOptionIndex].classList.add('selected');

    respuestaSeleccionada = true;
    cambioHabilitado = false;

    // Habilitar el cambio después de 900 ms solo si no hay otra respuesta seleccionada
    setTimeout(() => {
        if (!respuestaSeleccionada) {
            cambioHabilitado = true;
        }
    }, 900);
}

// Función para generar el archivo CSV al finalizar el test
function generarArchivoCSV() {
    // Verificar si hay respuestas seleccionadas
    if (respuestasSeleccionadas.length === 0) {
        console.log('No hay respuestas seleccionadas.');
        return;
    }

    // Crear el contenido del archivo CSV
    let csvContent = "Item, Opcion seleccionada, Es correcta, Tiempo (segundos), Tiempo (minutos)\n";
    respuestasSeleccionadas.forEach(respuesta => {
        // Convertir el tiempo de milisegundos a segundos y minutos
        const tiempoEnSegundos = respuesta.tiempo / 1000;
        const tiempoEnMinutos = respuesta.tiempo / 60000;

        // Agregar los tiempos en segundos y minutos al CSV
        csvContent += `${respuesta.item}, ${respuesta.opcionSeleccionada}, ${respuesta.esCorrecta}, ${tiempoEnSegundos}, ${tiempoEnMinutos}\n`;
    });

    // Crear un blob a partir del contenido del CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });

    // Obtener la fecha y la hora actuales
    const fechaActual = new Date();
    const año = fechaActual.getFullYear();
    const mes = String(fechaActual.getMonth() + 1).padStart(2, '0');
    const dia = String(fechaActual.getDate()).padStart(2, '0');
    const horas = String(fechaActual.getHours()).padStart(2, '0');
    const minutos = String(fechaActual.getMinutes()).padStart(2, '0');
    const segundos = String(fechaActual.getSeconds()).padStart(2, '0');

    // Formatear la fecha y la hora
    const fechaHoraFormateada = `${año}-${mes}-${dia}_${horas}-${minutos}-${segundos}`;

    // Crear un enlace de descarga para el archivo CSV
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `respuestas_story_based_${fechaHoraFormateada}.csv`;
    a.click();
    URL.revokeObjectURL(url); // Liberar la memoria asociada al objeto URL
}



function cambiarImagen(selectedOptionIndex) {
    if (!respuestaSeleccionada) {
        return;
    }

    // Aquí se cambia la lógica para avanzar a la siguiente imagen
    indiceActual++;
    respuestaSeleccionada = false;
    if (indiceActual === imagenes.length) {
        mostrarFinalizacion();
    } else {
        mostrarImagen(indiceActual);
    }
}

document.getElementById('startButton').addEventListener('click', iniciarPresentacion);

mostrarImagen(indiceActual); // Mostrar la primera imagen al cargar la página
