const imagenes = [
    {
        preliminar: "imagenes/practica/SET_item_practica_page-0001.jpg",
        src: "imagenes/practica/SET_item_practica1.jpg",
        textoDistintivo: "P1",
        options: [
            { src: "imagenes/practica/A.jpg", letter: 'a' },
            { src: "imagenes/practica/B.jpg", letter: 'b' },
            { src: "imagenes/practica/C.jpg", letter: 'c' },
        ],
        correct: 'b'
    },
    {
        preliminar: "imagenes/1-SET.IA/1/1_SET-IA_item1.jpg",
        src: "imagenes/1-SET.IA/1/1_SET-IA_item1.1.jpg",
        textoDistintivo: "IA1",
        options: [
            { src: "imagenes/1-SET.IA/1/1_SET-IA_item1.2.jpg", letter: 'a' },
            { src: "imagenes/1-SET.IA/1/1_SET-IA_item1.3.jpg", letter: 'b' },
            { src: "imagenes/1-SET.IA/1/1_SET-IA_item1.4.jpg", letter: 'c' },
        ],
        correct: 'c'
    },
    {
        preliminar: "imagenes/1-SET.IA/2/1_SET-IA_item2.jpg",
        src: "imagenes/1-SET.IA/2/1_SET-IA_item2.1.jpg",
        textoDistintivo: "IA2",
        options: [
            { src: "imagenes/1-SET.IA/2/1_SET-IA_item2.2.jpg", letter: 'a' },
            { src: "imagenes/1-SET.IA/2/1_SET-IA_item2.3.jpg", letter: 'b' },
            { src: "imagenes/1-SET.IA/2/1_SET-IA_item2.4.jpg", letter: 'c ' },
        ],
        correct: 'b'
    },
    {
        preliminar: "imagenes/1-SET.IA/3/1_SET-IA_item3.jpg",
        src: "imagenes/1-SET.IA/3/1_SET-IA_item3.1.jpg",
        textoDistintivo: "IA3",
        options: [
            { src: "imagenes/1-SET.IA/3/1_SET-IA_item3.2.jpg", letter: 'a' },
            { src: "imagenes/1-SET.IA/3/1_SET-IA_item3.3.jpg", letter: 'b' },
            { src: "imagenes/1-SET.IA/3/1_SET-IA_item3.4.jpg", letter: 'c' },
        ],
        correct: 'b'
    },
    {
        preliminar: "imagenes/1-SET.IA/4/1_SET-IA_item4.jpg",
        src: "imagenes/1-SET.IA/4/1_SET-IA_item4.1.jpg",
        textoDistintivo: "IA4",
        options: [
            { src: "imagenes/1-SET.IA/4/1_SET-IA_item4.2.jpg", letter: 'a' },
            { src: "imagenes/1-SET.IA/4/1_SET-IA_item4.3.jpg", letter: 'b' },
            { src: "imagenes/1-SET.IA/4/1_SET-IA_item4.4.jpg", letter: 'c' },
        ],
        correct: 'a'
    },
    {
        preliminar: "imagenes/1-SET.IA/5/1_SET-IA_item5.jpg",
        src: "imagenes/1-SET.IA/5/1_SET-IA_item5.1.jpg",
        textoDistintivo: "IA5",
        options: [
            { src: "imagenes/1-SET.IA/5/1_SET-IA_item5.2.jpg", letter: 'a' },
            { src: "imagenes/1-SET.IA/5/1_SET-IA_item5.3.jpg", letter: 'b' },
            { src: "imagenes/1-SET.IA/5/1_SET-IA_item5.4.jpg", letter: 'c' },
        ],
        correct: 'a'
    },
    {
        preliminar: "imagenes/1-SET.IA/6/1_SET-IA_item6.jpg",
        src: "imagenes/1-SET.IA/6/1_SET-IA_item6.1.jpg",
        textoDistintivo: "IA6",
        options: [
            { src: "imagenes/1-SET.IA/6/1_SET-IA_item6.2.jpg", letter: 'a' },
            { src: "imagenes/1-SET.IA/6/1_SET-IA_item6.3.jpg", letter: 'b' },
            { src: "imagenes/1-SET.IA/6/1_SET-IA_item6.4.jpg", letter: 'c' },
        ],
        correct: 'b'
    },
    {
        preliminar: "imagenes/2-SET-CI/1/2_SET-CI_item1.jpg",
        src: "imagenes/2-SET-CI/1/2_SET-CI_item1.1.jpg",
        textoDistintivo: "CI1",
        options: [
            { src: "imagenes/2-SET-CI/1/2_SET-CI_item1.2.jpg", letter: 'a' },
            { src: "imagenes/2-SET-CI/1/2_SET-CI_item1.3.jpg", letter: 'b' },
            { src: "imagenes/2-SET-CI/1/2_SET-CI_item1.4.jpg", letter: 'c' },
        ],
        correct: 'a'
    },
    {
        preliminar: "imagenes/2-SET-CI/2/2_SET-CI_item2.jpg",
        src: "imagenes/2-SET-CI/2/2_SET-CI_item2.1.jpg",
        textoDistintivo: "CI2",
        options: [
            { src: "imagenes/2-SET-CI/2/2_SET-CI_item2.2.jpg", letter: 'a' },
            { src: "imagenes/2-SET-CI/2/2_SET-CI_item2.3.jpg", letter: 'b' },
            { src: "imagenes/2-SET-CI/2/2_SET-CI_item2.4.jpg", letter: 'c' },
        ],
        correct: 'c'
    },
    {
        preliminar: "imagenes/2-SET-CI/3/2_SET-CI_item3.jpg",
        src: "imagenes/2-SET-CI/3/2_SET-CI_item3.1.jpg",
        textoDistintivo: "CI3",
        options: [
            { src: "imagenes/2-SET-CI/3/2_SET-CI_item3.2.jpg", letter: 'a' },
            { src: "imagenes/2-SET-CI/3/2_SET-CI_item3.3.jpg", letter: 'b' },
            { src: "imagenes/2-SET-CI/3/2_SET-CI_item3.4.jpg", letter: 'c' },
        ],
        correct: 'b'
    },
    {
        preliminar: "imagenes/2-SET-CI/4/2_SET-CI_item4.jpg",
        src: "imagenes/2-SET-CI/4/2_SET-CI_item4.1.jpg",
        textoDistintivo: "CI4",
        options: [
            { src: "imagenes/2-SET-CI/4/2_SET-CI_item4.2.jpg", letter: 'a' },
            { src: "imagenes/2-SET-CI/4/2_SET-CI_item4.3.jpg", letter: 'b' },
            { src: "imagenes/2-SET-CI/4/2_SET-CI_item4.4.jpg", letter: 'c' },
        ],
        correct: 'b'
    },
    {
        preliminar: "imagenes/2-SET-CI/5/2_SET-CI_item5.jpg",
        src: "imagenes/2-SET-CI/5/2_SET-CI_item5.1.jpg",
        textoDistintivo: "CI5",
        options: [
            { src: "imagenes/2-SET-CI/5/2_SET-CI_item5.2.jpg", letter: 'a' },
            { src: "imagenes/2-SET-CI/5/2_SET-CI_item5.3.jpg", letter: 'b' },
            { src: "imagenes/2-SET-CI/5/2_SET-CI_item5.4.jpg", letter: 'c' },
        ],
        correct: 'a'
    },
    {
        preliminar: "imagenes/2-SET-CI/6/2_SET-CI_items_prueba_page-0012.jpg",
        src: "imagenes/2-SET-CI/6/2_SET-CI_item6.jpg",
        textoDistintivo: "CI6",
        options: [
            { src: "imagenes/2-SET-CI/6/2_SET-CI_item6.1.jpg", letter: 'a' },
            { src: "imagenes/2-SET-CI/6/2_SET-CI_item6.2.jpg", letter: 'b' },
            { src: "imagenes/2-SET-CI/6/2_SET-CI_item6.3.jpg", letter: 'c' },
        ],
        correct: 'c'
    },
    {
        preliminar: "imagenes/3-SET-EA/1/3_SET-EA_items_prueba_page-0002.jpg",
        src: "imagenes/3-SET-EA/1/3_SET-EA_item1.jpg",
        textoDistintivo: "EA1",
        options: [
            { src: "imagenes/3-SET-EA/1/3_SET-EA_item1.1.jpg", letter: 'a' },
            { src: "imagenes/3-SET-EA/1/3_SET-EA_item1.2.jpg", letter: 'b' },
            { src: "imagenes/3-SET-EA/1/3_SET-EA_item1.3.jpg", letter: 'c' },
        ],
        correct: 'c'
    },
    {
        preliminar: "imagenes/3-SET-EA/2/3_SET-EA_items_prueba_page-0004.jpg",
        src: "imagenes/3-SET-EA/2/3_SET-EA_item2.jpg",
        textoDistintivo: "EA2",
        options: [
            { src: "imagenes/3-SET-EA/2/3_SET-EA_item2.1.jpg", letter: 'a' },
            { src: "imagenes/3-SET-EA/2/3_SET-EA_item2.2.jpg", letter: 'b' },
            { src: "imagenes/3-SET-EA/2/3_SET-EA_item2.3.jpg", letter: 'c' },
        ],
        correct: 'c'
    },
    {
        preliminar: "imagenes/3-SET-EA/3/3_SET-EA_items_prueba_page-0006.jpg",
        src: "imagenes/3-SET-EA/3/3_SET-EA_item3.jpg",
        textoDistintivo: "EA3",
        options: [
            { src: "imagenes/3-SET-EA/3/3_SET-EA_item3.1.jpg", letter: 'a' },
            { src: "imagenes/3-SET-EA/3/3_SET-EA_item3.2.jpg", letter: 'b' },
            { src: "imagenes/3-SET-EA/3/3_SET-EA_item3.3.jpg", letter: 'c' },
        ],
        correct: 'a'
    },
    {
        preliminar: "imagenes/3-SET-EA/4/3_SET-EA_items_prueba_page-0008.jpg",
        src: "imagenes/3-SET-EA/4/3_SET-EA_item4.jpg",
        textoDistintivo: "EA4",
        options: [
            { src: "imagenes/3-SET-EA/4/3_SET-EA_item4.1.jpg", letter: 'a' },
            { src: "imagenes/3-SET-EA/4/3_SET-EA_item4.2.jpg", letter: 'b' },
            { src: "imagenes/3-SET-EA/4/3_SET-EA_item4.3.jpg", letter: 'c' },
        ],
        correct: 'b'
    },
    {
        preliminar: "imagenes/3-SET-EA/5/3_SET-EA_items_prueba_page-0010.jpg",
        src: "imagenes/3-SET-EA/5/3_SET-EA_item5.jpg",
        textoDistintivo: "EA5",
        options: [
            { src: "imagenes/3-SET-EA/5/3_SET-EA_item5.1.jpg", letter: 'a' },
            { src: "imagenes/3-SET-EA/5/3_SET-EA_item5.2.jpg", letter: 'b' },
            { src: "imagenes/3-SET-EA/5/3_SET-EA_item5.3.jpg", letter: 'c' },
        ],
        correct: 'b'
    },
    {
        preliminar: "imagenes/3-SET-EA/6/3_SET-EA_items_prueba_page-0012.jpg",
        src: "imagenes/3-SET-EA/6/3_SET-EA_item6.jpg",
        textoDistintivo: "EA6",
        options: [
            { src: "imagenes/3-SET-EA/6/3_SET-EA_item6.1.jpg", letter: 'a' },
            { src: "imagenes/3-SET-EA/6/3_SET-EA_item6.2.jpg", letter: 'b' },
            { src: "imagenes/3-SET-EA/6/3_SET-EA_item6.3.jpg", letter: 'c' },
        ],
        correct: 'a'
    },
];


let indiceActual = 0;
let presentacionIniciada = false;
let itemStartTime;
let startTime;
let practice = true;
const fullscreenButton = document.getElementById('fullscreenButton');
let selectedHand = "";
document.getElementById('startButton').addEventListener('click', iniciarPresentacion);

fullscreenButton.addEventListener('click', () => {
    if (document.fullscreenEnabled && !document.fullscreenElement) {
        fullscreenButton.style.backgroundImage = "url('imagenes/minimize.png')"; // Cambiar la imagen del botón a 'minimize'
        document.documentElement.requestFullscreen();
    } else if (document.fullscreenElement) {
        fullscreenButton.style.backgroundImage = "url('imagenes/full-screen.png')"; // Cambiar la imagen del botón a 'full-screen'
        document.exitFullscreen();
    } else {
        console.log('El modo de pantalla completa no es soportado por tu navegador.');
    }
});

function iniciarPresentacion() {
    document.getElementById('instrucciones').pause();
    presentacionIniciada = true;
    const imageContainer = document.getElementById('imageContainer');
    const instructionText = document.getElementById('instructionText');
    const instrucciones = document.getElementById('instrucciones');
    const startButton = document.getElementById('startButton');
    const fullscreenButton = document.getElementById('fullscreenButton');
    startTime = new Date(); // Registrar el tiempo de inicio del test
    
    instructionText.style.display = 'none';
    instrucciones.style.display = 'none';
    startButton.style.display = 'none';
    fullscreenButton.style.display = 'none';
    imageContainer.style.display = 'block';
    mostrarImagen(indiceActual);
}

function mostrarImagenPrincipal() {
    const preliminaryImage = document.getElementById('preliminaryImage');
    const showMainButton = document.getElementById('showMainButton');
    const storyImage = document.getElementById('storyImage');
    const optionsContainer = document.getElementById('optionsContainer');
    const continueButton = document.getElementById('continueButton');

    preliminaryImage.style.display = 'none';
    showMainButton.style.display = 'none';

    storyImage.src = imagenes[indiceActual].src;
    storyImage.style.display = 'block';
    continueButton.style.display = 'block';

    optionsContainer.innerHTML = '';
    imagenes[indiceActual].options.forEach((option, index) => {
        const optionImage = document.createElement('img');
        optionImage.src = option.src;
        optionImage.classList.add('option');

        optionImage.addEventListener('click', () => {
            verificarRespuesta(index);
        });

        optionsContainer.appendChild(optionImage);
    });
    optionsContainer.style.display = 'flex';

    // Limpiar event listener previo del botón continueButton
    continueButton.removeEventListener('click', handleContinueClick);
    continueButton.addEventListener('click', handleContinueClick);
}

function handleContinueClick() {
    cambiarImagen(); 
}

document.getElementById('participantID').addEventListener('input', validateInputs);
let participantID = 0;

function validateInputs() {
    participantID = document.getElementById('participantID').value;
    selectedHand = document.querySelector('input[name="hand"]:checked')?.value;
    
    if (participantID && selectedHand) {
        handButton.style.display = 'block';
    } 
}


function mostrarImagen(indice) {
    const imagenInfo = imagenes[indice];
    const preliminaryImage = document.getElementById('preliminaryImage');
    const showMainButton = document.getElementById('showMainButton');
    const storyImage = document.getElementById('storyImage');
    const optionsContainer = document.getElementById('optionsContainer');
    const imageContainer = document.getElementById('imageContainer');
    const continueButton = document.getElementById('continueButton');

    // Ocultar todas las imágenes antes de cargar la nueva imagen
    preliminaryImage.style.display = 'none';
    storyImage.style.display = 'none';
    continueButton.style.display = 'none';
    optionsContainer.style.display = 'none'; // Ocultar el contenedor de opciones

    // Mostrar imagen preliminar y botón "Mostrar imagen principal" si no hay imagen de inicio
    if (!imagenInfo.inicio) {
        preliminaryImage.src = imagenInfo.preliminar;
        preliminaryImage.style.display = 'block';
        showMainButton.style.display = 'block';
    } else {
        // Si hay imagen de inicio, mostrarla durante 3 segundos y luego mostrar la imagen preliminar
        const inicioImage = document.getElementById('inicioImage');
        inicioImage.src = imagenInfo.inicio;
        inicioImage.style.display = 'block';

        setTimeout(() => {
            preliminaryImage.src = imagenInfo.preliminar;
            preliminaryImage.style.display = 'block';
            showMainButton.style.display = 'block';
            inicioImage.style.display = 'none'; // Ocultar la imagen de inicio después de 3 segundos
        }, 1500); // Mostrar la imagen de inicio durante 3 segundos
    }

    const existingImageText = document.querySelector('.imageText');
    if (existingImageText) {
        imageContainer.removeChild(existingImageText);
    }

    // Limpiar las opciones anteriores
    optionsContainer.innerHTML = '';

    // Agregar texto distintivo a algunas imágenes
    if (imagenInfo.textoDistintivo) {
        const imageText = document.createElement('div');
        imageText.textContent = imagenInfo.textoDistintivo;
        imageText.classList.add('imageText');
        imageContainer.appendChild(imageText);
    }
}

let tiempoInicio; // Variable para almacenar el tiempo de inicio del temporizador

document.getElementById('showMainButton').addEventListener('click', function () {
    mostrarImagenPrincipal();
    // Iniciar el temporizador al presionar el botón "showMainButton"
    tiempoInicio = Date.now();
});


let respuestaSeleccionada = false; // Variable para verificar si se seleccionó una respuesta

let respuestasSeleccionadas = []; // Array para almacenar las respuestas seleccionadas

function verificarRespuesta(selectedOptionIndex) {
    const itemActual = imagenes[indiceActual];
    const correctOptionIndex = itemActual.options.findIndex(option => option.letter === itemActual.correct);
    const letraSeleccionada = itemActual.options[selectedOptionIndex].letter;
    const letraCorrecta = itemActual.options[correctOptionIndex].letter;

    const tiempoTranscurrido = Date.now() - tiempoInicio;

    // Solo registrar la respuesta si no se ha registrado una para este ítem
    if (!respuestaSeleccionada) {
        respuestasSeleccionadas.push({
            item: itemActual.textoDistintivo,
            opcionSeleccionada: letraSeleccionada,
            respuestaCorrecta: letraCorrecta,
            tiempo: tiempoTranscurrido
        });

        respuestaSeleccionada = true;
    }

    document.querySelectorAll('.option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelectorAll('.option')[selectedOptionIndex].classList.add('selected');

}

function cambiarImagen(selectedOptionIndex) {
    if (indiceActual >= imagenes.length) {
        console.error("Índice fuera de rango:", indiceActual);
        return;
    }

    if (respuestaSeleccionada || selectedOptionIndex === undefined) {
        if (selectedOptionIndex === undefined) {
            // Solo agregar respuesta omitida si no se ha registrado una respuesta
            if (!respuestaSeleccionada) {
                respuestasSeleccionadas.push({
                    item: imagenes[indiceActual].textoDistintivo,
                    opcionSeleccionada: '',
                    respuestaCorrecta: imagenes[indiceActual].correct,
                    tiempo: Date.now() - tiempoInicio
                });
            }
        }

        respuestaSeleccionada = false; // Reiniciar la variable para el siguiente ítem
        indiceActual++;
        respuestaSeleccionada = false;
        if (practice) {
            practice = false;
            mostrarInstrucciones();
            return;
        }
        if (indiceActual === imagenes.length) {
            const imageContainer = document.getElementById('imageContainer');
            imageContainer.style.display = 'none';
            document.getElementById('continueButton').style.display = 'none';
            const previousImageText = document.querySelector('.imageText');
            if (previousImageText) {
                previousImageText.remove();
            }
            showHandSelection();
        } else {
            mostrarImagen(indiceActual);
        }
    }
}

function generarArchivoCSV() {
    selectHandContainer.style.display = "none";
    enterID.style.display = 'none';
    handButton.style.display = 'none';
    if (respuestasSeleccionadas.length === 0) {
        console.log('No hay respuestas seleccionadas.');
        return;
    }

    let csvContent = "";
    const endTime = new Date();
    const totalTestTime = (endTime - startTime); // Tiempo total en milisegundos

    csvContent += "en;rp_c;rp;pc;tr\n";

    let respuestasCorrectas = respuestasSeleccionadas.filter(respuesta =>
        respuesta.opcionSeleccionada === respuesta.respuestaCorrecta
    ).length;

    respuestasSeleccionadas.forEach(respuesta => {
        const tiempoConComa = (respuesta.tiempo).toFixed(3).replace('.', ',');
        const precision = respuesta.opcionSeleccionada === respuesta.respuestaCorrecta ? 1 : 0;

        csvContent += `${respuesta.item};${respuesta.opcionSeleccionada};${respuesta.respuestaCorrecta};${precision};${tiempoConComa}\n`;
    });

    const csvBlob = new Blob([csvContent], { type: 'text/csv' });

    const txtContent = `Tiempo dedicado (segundos): ${totalTestTime / 1000}\nMano utilizada: ${selectedHand}\n`;
    const txtBlob = new Blob([txtContent], { type: 'text/plain' });

    // Obtener la fecha y la hora actuales
    const fechaActual = new Date();
    const options = { timeZone: 'America/Santiago', year: 'numeric', month: 'numeric', day: 'numeric' };
    const fechaHoraChilena = fechaActual.toLocaleString('es-CL', options);
    const [day, month, year] = fechaHoraChilena.split('-');
    const fechaFormateada = `${day}_${month}_${year}`;

    // Crear el archivo ZIP
    const zip = new JSZip();
    zip.file(`${participantID}_StoryBasedEmpathyTask_${fechaFormateada}.csv`, csvBlob);
    zip.file(`${participantID}_StoryBasedEmpathyTask_${fechaFormateada}.txt`, txtBlob);

    zip.generateAsync({ type: "blob" })
        .then(content => {
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const zipFilename = `${participantID}_StoryBasedEmpathyTask_${fechaFormateada}.zip`;
                const url = URL.createObjectURL(content);
                link.setAttribute('href', url);
                link.setAttribute('download', zipFilename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        })
        .catch(err => {
            console.error("Error generando el archivo ZIP:", err);
        });
}

function mostrarInstrucciones() {
    const imageContainer = document.getElementById('imageContainer');
    const instructionText = document.getElementById('instructionText');
    const instrucciones = document.getElementById('instrucciones');
    const startButton = document.getElementById('startButton');
    instructionText.style.display = 'block';
    instrucciones.style.display = 'block';
    startButton.style.display = 'block';
    imageContainer.style.display = 'none';
    instructionText.textContent = 'Ahora comenzará la tarea de verdad. Por favor, responda tan rápido como pueda.';

    // Cambia la fuente del audio
    const audioElement = document.getElementById('instrucciones');
    audioElement.src = 'instrucciones2.mp3';
    audioElement.load(); // Carga la nueva fuente
}


mostrarImagen(indiceActual); // Mostrar la primera imagen al cargar la página


const selectHandContainer = document.getElementById("selectHand");
const handButton = document.getElementById("handButton");
const handInputs = document.getElementsByName('hand');
const fin = document.getElementById('fin');
const enterID = document.getElementById('enterID');

// Variable con la mano seleccionada

// Funcion para mostrar la pantalla de seleccion de mano
function showHandSelection() {
    fin.style.display = 'block';
    selectHandContainer.style.display = "block";
    enterID.style.display = 'block';

    handButton.addEventListener('click', function () {
        generarArchivoCSV();
    });
}

function confirmHandSelection() {
    selectHandContainer.style.display = "none";
    generarArchivoCSV();
}

// Se asigna el valor seleccionado a la variable selectedHand para su uso en csv
handInputs.forEach(input => {
    input.addEventListener('change', validateInputs);
});

